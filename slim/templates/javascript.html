<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script language="javascript" type="text/javascript">
    
		String.prototype.reverse = function() {
		  return this.split('').reverse().join('');
		}
		String.prototype.slice = function(startIndex, endIndex, step) {
            var result = "";
            if(!endIndex && !step) {
            	return this.charAt(startIndex);
            }
            
            if(!endIndex) {
            	endIndex = this.length;
            }
            if(!step) {
            	step = 1;
            }
            if(startIndex < endIndex && step < 0 || startIndex > endIndex && step > 0 || step == 0) {
            	throw("indexes are wrong");
            }
            
            for (var i = startIndex; i != endIndex; i += step)
            {
                result += this.charAt(i);
            }
			return result;
		}
        
		// 
// 		var go = "helloworld";
// 		console.log(go.slice(4, -1, -1));
// 		
// 		
//     	var blah = "quality=hd720\u0026type=video%2Fmp4%3B+codecs%3D%22avc1.64001F%2C+mp4a.40.2%22\u0026url=http%3A%2F%2Fr4---sn-xmxuxa-coxe.googlevideo.com%2Fvideoplayback%3Fid%3D536312798653a858%26sparams%3Did%252Cip%252Cipbits%252Citag%252Cratebypass%252Csource%252Cupn%252Cexpire%26sver%3D3%26upn%3D2DK2mgzqyPQ%26ms%3Dau%26fexp%3D909708%252C919376%252C910207%252C943103%252C916611%252C926106%252C934207%252C936910%252C936913%252C907231%252C921090%252C3300072%252C3300113%252C3300130%252C3300137%252C3300161%252C3310625%252C3310649%26mt%3D1390102663%26mv%3Dm%26ip%3D58.96.54.36%26key%3Dyt5%26itag%3D22%26expire%3D1390125251%26ratebypass%3Dyes%26ipbits%3D0%26source%3Dyoutube\u0026fallback_host=tc.v4.cache3.googlevideo.com\u0026itag=22\u0026sig=124C6299DC1340984864C09B9B11843BC8A081D2.A43208BA428EA13339C036D14BA95875F90531B8,quality=medium\u0026type=video%2Fwebm%3B+codecs%3D%22vp8.0%2C+vorbis%22\u0026url=http%3A%2F%2Fr4---sn-xmxuxa-coxe.googlevideo.com%2Fvideoplayback%3Fid%3D536312798653a858%26sparams%3Did%252Cip%252Cipbits%252Citag%252Cratebypass%252Csource%252Cupn%252Cexpire%26sver%3D3%26upn%3D2DK2mgzqyPQ%26ms%3Dau%26fexp%3D909708%252C919376%252C910207%252C943103%252C916611%252C926106%252C934207%252C936910%252C936913%252C907231%252C921090%252C3300072%252C3300113%252C3300130%252C3300137%252C3300161%252C3310625%252C3310649%26mt%3D1390102663%26mv%3Dm%26ip%3D58.96.54.36%26key%3Dyt5%26itag%3D43%26expire%3D1390125251%26ratebypass%3Dyes%26ipbits%3D0%26source%3Dyoutube\u0026fallback_host=tc.v21.cache6.googlevideo.com\u0026itag=43\u0026sig=E1514E272A7DD8310E5DD57A7E837E308BC45C19.EDE2C86674D8E3A14B7DB79877F23D6E0AAC9B23,quality=medium\u0026type=video%2Fmp4%3B+codecs%3D%22avc1.42001E%2C+mp4a.40.2%22\u0026url=http%3A%2F%2Fr4---sn-xmxuxa-coxe.googlevideo.com%2Fvideoplayback%3Fid%3D536312798653a858%26sparams%3Did%252Cip%252Cipbits%252Citag%252Cratebypass%252Csource%252Cupn%252Cexpire%26sver%3D3%26upn%3D2DK2mgzqyPQ%26ms%3Dau%26fexp%3D909708%252C919376%252C910207%252C943103%252C916611%252C926106%252C934207%252C936910%252C936913%252C907231%252C921090%252C3300072%252C3300113%252C3300130%252C3300137%252C3300161%252C3310625%252C3310649%26mt%3D1390102663%26mv%3Dm%26ip%3D58.96.54.36%26key%3Dyt5%26itag%3D18%26expire%3D1390125251%26ratebypass%3Dyes%26ipbits%3D0%26source%3Dyoutube\u0026fallback_host=tc.v1.cache8.googlevideo.com\u0026itag=18\u0026sig=F9C51F153032DCA4C5A850FB73C6A06632902139.B3F9A37A8EA193EF67866C44DDE6C511F476976E,quality=small\u0026type=video%2Fx-flv\u0026url=http%3A%2F%2Fr4---sn-xmxuxa-coxe.googlevideo.com%2Fvideoplayback%3Fid%3D536312798653a858%26algorithm%3Dthrottle-factor%26mv%3Dm%26sver%3D3%26factor%3D1.25%26fexp%3D909708%252C919376%252C910207%252C943103%252C916611%252C926106%252C934207%252C936910%252C936913%252C907231%252C921090%252C3300072%252C3300113%252C3300130%252C3300137%252C3300161%252C3310625%252C3310649%26ms%3Dau%26sparams%3Dalgorithm%252Cburst%252Cfactor%252Cid%252Cip%252Cipbits%252Citag%252Csource%252Cupn%252Cexpire%26mt%3D1390102663%26burst%3D40%26source%3Dyoutube%26key%3Dyt5%26itag%3D5%26expire%3D1390125251%26upn%3D2DK2mgzqyPQ%26ipbits%3D0%26ip%3D58.96.54.36\u0026fallback_host=tc.v18.cache8.googlevideo.com\u0026itag=5\u0026sig=BF801898467E51097F4AAC98B6E3C4A762727307.69573AAF5108880DBA5E353B0D842091963714CC,quality=small\u0026type=video%2F3gpp%3B+codecs%3D%22mp4v.20.3%2C+mp4a.40.2%22\u0026url=http%3A%2F%2Fr4---sn-xmxuxa-coxe.googlevideo.com%2Fvideoplayback%3Fid%3D536312798653a858%26algorithm%3Dthrottle-factor%26mv%3Dm%26sver%3D3%26factor%3D1.25%26fexp%3D909708%252C919376%252C910207%252C943103%252C916611%252C926106%252C934207%252C936910%252C936913%252C907231%252C921090%252C3300072%252C3300113%252C3300130%252C3300137%252C3300161%252C3310625%252C3310649%26ms%3Dau%26sparams%3Dalgorithm%252Cburst%252Cfactor%252Cid%252Cip%252Cipbits%252Citag%252Csource%252Cupn%252Cexpire%26mt%3D1390102663%26burst%3D40%26source%3Dyoutube%26key%3Dyt5%26itag%3D36%26expire%3D1390125251%26upn%3D2DK2mgzqyPQ%26ipbits%3D0%26ip%3D58.96.54.36\u0026fallback_host=tc.v16.cache4.googlevideo.com\u0026itag=36\u0026sig=B2A2F82AA67389458CCBDCA77E086D6683B525F5.AD64D4D8C1E32BFB3FAC8AFB177FD1E98E4AF49E,quality=small\u0026type=video%2F3gpp%3B+codecs%3D%22mp4v.20.3%2C+mp4a.40.2%22\u0026url=http%3A%2F%2Fr4---sn-xmxuxa-coxe.googlevideo.com%2Fvideoplayback%3Fid%3D536312798653a858%26algorithm%3Dthrottle-factor%26mv%3Dm%26sver%3D3%26factor%3D1.25%26fexp%3D909708%252C919376%252C910207%252C943103%252C916611%252C926106%252C934207%252C936910%252C936913%252C907231%252C921090%252C3300072%252C3300113%252C3300130%252C3300137%252C3300161%252C3310625%252C3310649%26ms%3Dau%26sparams%3Dalgorithm%252Cburst%252Cfactor%252Cid%252Cip%252Cipbits%252Citag%252Csource%252Cupn%252Cexpire%26mt%3D1390102663%26burst%3D40%26source%3Dyoutube%26key%3Dyt5%26itag%3D17%26expire%3D1390125251%26upn%3D2DK2mgzqyPQ%26ipbits%3D0%26ip%3D58.96.54.36\u0026fallback_host=tc.v7.cache4.googlevideo.com\u0026itag=17\u0026sig=6C4C635A81445B11E3FBE86DD3FBCE59DC007EE2.8804CF53ECF9039286D47052E381948221738621";
//     	
//     	console.log(findUrl(blah.split(","), 37));
			
			
    	function getUrl(html, quality) {
    		if(!quality) {
    			quality = 18;
    		}
    		var myRegexp = new RegExp("ytplayer\.config = (.*?);<\/script>", "gis");
    		var match = myRegexp.exec(html);
    		var jsonString = match[1];
			var config = JSON.parse(jsonString);			
			var fmtStreams = config.args.url_encoded_fmt_stream_map.split(",");
    		return findUrl(fmtStreams, quality);
		}
		
		function findUrl(fmtStreams, quality) {
			var bestQualityFound = 18;
			var url;
			for (var i = 0; i < fmtStreams.length; ++i) {
				var fmtStream = queryStringToHash(fmtStreams[i]);
				if(fmtStream.itag <= quality && fmtStream.itag >= bestQualityFound && fmtStream.type.indexOf("video/mp4") != -1) {
					bestQualityFound = fmtStream.itag;
					if(fmtStream.sig) {
						url = fmtStream.url + "&signature=" + fmtStream.sig;					
					} else {
						url = fmtStream.url + "&signature=" + decryptSignature2(fmtStream.s);					
					}
				}
			}
			return url;
    	}
    	
    	function queryStringToHash(query) {
			var query_string = {};
			var vars = query.split("&");
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				pair[0] = decodeURIComponent(pair[0]);
				pair[1] = decodeURIComponent(pair[1]);
					// If first entry with this name
				if (typeof query_string[pair[0]] === "undefined") {
					query_string[pair[0]] = pair[1];
					// If second entry with this name
				} else if (typeof query_string[pair[0]] === "string") {
					var arr = [ query_string[pair[0]], pair[1] ];
					query_string[pair[0]] = arr;
					// If third or later entry with this name
				} else {
					query_string[pair[0]].push(pair[1]);
				}
			} 
			return query_string;
		};
		
		// source: http://userscripts.org/scripts/review/87011
		// related: 
		
		var ytDecrypter = null;
  var ytDecryptFunction = null;
		function decryptSignature2(s) {
    if (typeof ytDecrypter === 'function') {
      return ytDecrypter(s);
    }
    else {
      if (!ytDecryptFunction) ytDecryptFunction = 'a=a.split("");a=Tk(a,4);a=a.slice(3);a=Tk(a,53);a=a.slice(2);return a.join("")';
      var ytFncSwap = ytDecryptFunction.match(/\w=(\w+)\(\w,[0-9]+\)/);
      ytFncSwap = (ytFncSwap) ? ytFncSwap[1] : null;
      if (ytFncSwap) {
	var ytFncBody = 'function ' + ytFncSwap + '(a, b)' + '{var c=a[0];a[0]=a[b%a.length];a[b]=c;return a} ' + ytDecryptFunction;
	ytDecrypter = new Function('a', ytFncBody);
	return ytDecrypter(s);
      }
    }
    return null;
  }
  
    </script>
</head>
</html>
